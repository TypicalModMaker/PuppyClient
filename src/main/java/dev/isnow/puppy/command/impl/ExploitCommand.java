package dev.isnow.puppy.command.impl;

import dev.isnow.puppy.Puppy;
import dev.isnow.puppy.command.Command;
import dev.isnow.puppy.command.CommandInfo;
import dev.isnow.puppy.exception.CommandException;
import dev.isnow.puppy.exploit.Exploit;
import dev.isnow.puppy.exploit.argument.ArgumentParser;
import dev.isnow.puppy.helper.ChatHelper;
import dev.isnow.puppy.helper.ExecutorHelper;

import java.util.Arrays;
import java.util.stream.Collectors;

@CommandInfo(
    alias = "crash",
    description = "Crashes the server [1.7-1.8.9 ONLY]",
    usage = ".crash <method/list> [method arguments]",
    aliases = {"exploit", "lag"}
)
public class ExploitCommand extends Command {

  @Override
  public void execute(String... args) throws CommandException {
    if (args.length == 0) {
      throw new CommandException("Usage: &c" + getUsage());
    }

    if (args[0].equalsIgnoreCase("list")) {
      ChatHelper.printMessage(
          "Available methods: &c" + Puppy.INSTANCE.getExploitManager().getExploits().stream().map(Exploit::getName).collect(Collectors.joining(", ")));
    } else if (args[0].equalsIgnoreCase("info") && args.length > 1) {
      Exploit<?> exploit = Puppy.INSTANCE.getExploitManager().getExploit(args[1])
          .orElseThrow(
              () -> new CommandException(String.format("Exploit \"%s\" not found.\n", args[1])));

      ChatHelper.printMessage(
          String.format("&5%s&f: &c%s\n", exploit.getName(), exploit.getDescription()));

    } else {
      Exploit<?> exploit = Puppy.INSTANCE.getExploitManager().getExploit(args[0])
          .orElseThrow(() -> new CommandException(
              "Exploit not found. Use \".exploit list\" to see all exploits."));

      Object[] arguments = ArgumentParser.parseArgs(exploit,
          Arrays.copyOfRange(args, 1, args.length)); //can't inline due to fucking error lol
      ExecutorHelper.submit(() -> exploit.execute(arguments));
    }
  }
}
